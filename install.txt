
Introduction

Reason is a web content management system designed for educational institutions.  It was 
created by the Web Services Group at Carleton College. This is the first release, and we 
thank you for your interest. The installation process outlined below is not simple, and 
assumes you have some experience installing Apache HTTPD, PHP, along with general Linux 
administrative skills.  

We are eager to help you get Reason installed on your system.  If you run into trouble or 
have any questions please do not hesitate to contact us at reason-support@lists.carleton.edu
or through the forum at http://reason-forum.carleton.edu/ .


Requirements

	Many of the packages listed here may already be installed on your system. Depending on the 
	distribution of Linux you're running there is likely to be a pre-built package available.

	Linux OS 
	We run RedHat Enterprise Linux AS4, but any distribution should do. 
	MacOSX appears to work just fine as well, but has not been extensively tested. 

	Apache HTTPD http://httpd.apache.org/ 
	Works with the 1.3, 2.0, and 2.2 branches. 
	
	PHP 4.x http://www.php.net
	Not currently compatible with PHP 5+

	MySQL http://www.mysql.org
	Works with 4.0 and 4.1, and 5

	Tidy http://tidy.sourceforge.net/#source 

	ImageMagick http://www.imagemagick.org/script/index.php 

	GDlib http://www.boutell.com/gd/

	ASpell http://aspell.sourceforge.net/
	(without ASpell the Loki spellcheck will be unable to find errors).


Unpack Reason

	When you unpack the Reason distribution you should place the
'reason_package' folder in a web accessible directory. Only certain portions
actually need to be under the webroot, but for simplicity we're keeping
everything there for now.


PHP Configuration

	Your PHP install must support MySQL connections, but it's likely that the version packaged 
with your Linux distribution will be fine. The configuration details we use in production are
listed in the PHP_configuration.txt file included alongside this install.txt. 

	The default php.ini file is probably fine as long as:
	
	1. phpinfo() shows mysql support
	2. short_open_tag is set to ON
	3. safe_mode is set to OFF
	4. file_uploads is set to ON
	5. output_buffer = 4096 (or greater) so that reason is able to send appropriate headers
					   for asset downloads (such as .pdf & .doc files)

	We recommend the following:
	
	1. register_globals set to OFF
	2. allow_call_time_pass_reference set to OFF

	Reason uses the error handler in carl_util and controls error reporting / display accordingly.
	The settings you specify in php.ini apply only to applications that do not use the error
	handler within carl_util.
	
	Reason will perform best if you compile PHP with libcurl, or have the command line version
	of curl available.
	
WebServer Configuration

The following configuration defines two Apache Virtual Host entries for Reason,
one for HTTP connections and the other for HTTPS connections.  The only
difference between the two entries are the redirects to HTTPS to secure
authentication and the SSL key/cert information.

As of Reason 4 Beta 4, Reason can operate in an insecure mode that does not
require an SSL certificate. If you choose to run Reason in an insecure setting
(not recommended), you will need to set the HTTPS_AVAILABLE constant in the 
package_settings.php file to false.

Otherwise, You will need to generate or purchase an SSL certificate before 
proceeding.  Please see the note in the "Reason Settings" section below if you 
choose to use a self signed certificate.


	Enable PHP:
	You will need the libphp module installed and enabled for reason to function. For PHP4 this
is enabled with the following line in httpd.conf:

LoadModule php4_module        modules/libphp4.so


	Configure your Reason VirtualHost:
	In the following example we have used values specific to our site.
The values for your installation will be different.

	192.168.0.100 
the IP address for apps.carleton.edu

	apps.carleton.edu 
our server hostname from which Reason pages will be served

	/usr/local/webapps/reason 
the location where we've stored our 'reason_package' directory unpacked from the source archive.

	/var/log/httpd/reason_access.log 
	/var/log/httpd/reason_error.log
If the /var/log/httpd path doesn't exist on your filesystem, create it or change these to a path which does.

	php_value include_path .:/usr/local/webapps/reason/reason_package/:/path/to/your/php/share/pear/
you must specify the /path/to/your/php/share/pear folder on your system

	SSLCertificateFile /path/to/your/server.crt
	SSLCertificateKeyFile /path/to/your/server.key
	SSLCACertificateFile /path/to/your/certificate.authority.crt
You must specify your web server certificate and key file paths. If you're using a self-signed certificate
you should specify the path to your certificate authority file as well.


#---VirtualHost.reason-Start----------------------------------------------------------------------------
Listen 192.168.0.100:80
Listen 192.168.0.100:443

<VirtualHost 192.168.0.100:80>
	DocumentRoot /usr/local/webapps/reason
	ServerName apps.carleton.edu
	php_value include_path .:/usr/local/webapps/reason/reason_package/:/path/to/your/php/share/pear/

  <Directory /usr/local/webapps/reason>
    AllowOverride All
    Order deny,allow
    Allow from all
  </Directory>

	# enables PHP for these extensions
	AddHandler application/x-httpd-php .php .php3 .php4 .phtml .php.xml .php.html .php.csv .php.css

	# prevents a script from running > 60 seconds
	php_value max_execution_time 60

	# data/assets should not be executable
	<DirectoryMatch data/assets>
		php_admin_value engine Off
	</DirectoryMatch>

	CustomLog /var/log/httpd/reason_access.log combined
	ErrorLog /var/log/httpd/reason_error.log

</VirtualHost>

<VirtualHost 192.168.0.100:443>
	DocumentRoot /usr/local/webapps/reason
	ServerName apps.carleton.edu
	php_value include_path .:/usr/local/webapps/reason/reason_package/:/path/to/your/php/share/pear/

  <Directory /usr/local/webapps/reason>
    AllowOverride All
    Order deny,allow
    Allow from all
  </Directory>

	# enables PHP for these extensions
	AddHandler application/x-httpd-php .php .php3 .php4 .phtml .php.xml .php.html .php.csv .php.css

	# prevents a script from running > 60 seconds
	php_value max_execution_time 60

	# data/assets should not be executable
	<DirectoryMatch data/assets>
		php_admin_value engine Off
	</DirectoryMatch>

	SSLEngine on
	SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
	SSLCertificateFile /path/to/your/server.crt
	SSLCertificateKeyFile /path/to/your/server.key
	SSLCACertificateFile /path/to/your/certificate.authority.crt
  
	<Files ~ "\.(cgi|shtml|phtml|php3?|php4)$">
  	SSLOptions +StdEnvVars
	</Files>

	CustomLog /var/log/httpd/reason_access.log combined
	ErrorLog /var/log/httpd/reason_error.log

</VirtualHost>
#---VirtualHost.reason-End------------------------------------------------------------------------------


Database Configuration

	Connect to your MySQL instance and create a database for reason:

		create database reason ; 


	Allow your webhost to connect

		grant all privileges on reason.* to reason_user@webhost identified by 'some_password';
		flush privileges ; 


	Dump the base reason database (reason4_b3.sql) into your new reason database. The reason4_b3.sql
	file is located in the reason_package at this location: /reason_package/reason_4.0/data/dbs/
	
	cat reason4_b4.sql | mysql -u reason_user --password=some_password -h your.mysql.hostname.or.ip.address reason

	In order to use reason's form "type", you need to create a database for the thor utility
	
		create database thor ;
		
		grant all privileges on thor.* to reason_user@webhost identified by 'some_password';
		
	As long as thor will be used with reason, the database can remain empty for now. Reason will 
automatically create the necessary tables the first time a form is created.

	The database connections used by Reason are defined in an XML file.  The location of
this file is specified by the DB_CREDENTIALS_FILEPATH constant in the reason_package/settings/package_settings.php 
file.  The location should not be web accessible as it will contain the account
credentials for your database. It's also sensible to make it readable only be
the account your web server runs under.

Below is the format it requires.  Fill in the information specific to your site:

#---dbs.xml-start---------------------------------------------------------------------------------------
<databases>
        <database>
                <connection_name>reason_connection</connection_name>
                <db>reason</db>
                <user>reason_user</user>
                <password>some_password</password>
                <host>your.mysql.hostname.or.ip.address</host>
        </database>
        <database>
                <connection_name>thor_connection</connection_name>
                <db>thor</db>
                <user>reason_user</user>
                <password>some_password</password>
                <host>your.mysql.hostname.or.ip.address</host>
        </database>
</databases>
#---dbs.xml-end-----------------------------------------------------------------------------------------


Configuring Reason Settings

To properly set up reason, you'll need to configure the following:

reason_package/settings/package_settings.php
reason_package/settings/reason_settings.php
reason_package/settings/dir_service_config.php
reason_package/settings/error_handler_settings.php
reason_package/settings/thor_settings.php
reason_package/settings/tyr_settings.php

We recommend copying the distributed settings to a backup folder so that you can revert and/or refer to them later.

*** reason_package/settings/package_settings.php ***
package_settings.php needs to be edited in order to setup paths specific to your instance of reason.
The following constants need to be setup properly for reason to function:

INCLUDE_PATH - location of the reason_package directory
WEB_PATH - file system path of the web root directory
HTTP_HOST_NAME - host-name (or IP) which hits WEB_PATH directory
PHP_CLI - file system path of the php binary to be used for command line operations
DB_CREDENTIALS FILEPATH - file system location of .xml file which defines database connections
TIDY_EXE - location of the tidy binary
IMAGEMAGICK_PATH - file system path to imagemagick functions
CURL_PATH - needed only if libcurl is not available
HTTPS_AVAILABLE - whether or not the server is capable of serving pages over https

If reason sites are going to be placed behind areas that require http authentication, then the 
HTTP_CREDENTIALS_FILEPATH constant must be defined. The constant should reference a file outside the web tree
which defines $http_authentication_username and $http_authentication_password. These variables are
used by curl to access areas behind http authentication.

*** reason_package/settings/reason_settings.php ***

The reason_settings.php file is reasonably well commented and needs to be configured according to 
your reason setup. Please note the block of options at the top of the file.  You will need to 
customize those settings specific to your installation.  Comments are provided which should 
help in determining the proper settings.  If you need assistance, please contact
reason-support@carleton.edu or visit http://reason-forum.carleton.edu .

ERROR_404_PAGE

Reason includes a custom 404 error page. The 404 error page includes functionality which
will redirect requests for resources that have moved to their new location.

To take advantage of the 404 functionality, you must use a custom 404 error page, and have the 
following two choices.

1. Change your apache config to use the custom 404 page included within the reason package
   (/reason_package/reason_4.0/www/errors/404.php)
OR

2. Add the following lines to a custom 404 error page located elsewhere:
   include_once( 'reason_header.php' );
   reason_include( 'scripts/urls/404action.php' );
   
   AND change the ERROR_404_PAGE setting in the reason settings file to reference your custom 404 page

   If you choose not to make these changes you'll see your web server's
default 404 page.


*** reason_package/settings/error_handler_settings.php ***
Near the top of the file, an array specifies Reason developer e-mail and IP addresses. Set
this up with your own local information, so that developers see onscreen warning, and are
properly notified via e-mail of more serious errors.  You will not see usefull
error messages until you customize this file with your own IP address. Please
see the notes included in the file.

*** reason_package/settings/tyr_settings.php ***
This file configures how emails are addressed when generated by reason forms.
The reply to email address defaults to the WEBMASTER_EMAIL_ADDRESS.  You can
change that entry with the TYR_REPLY_TO_EMAIL_ADDRESS in this file.

*******************************************************************************************

Cron Jobs

	Reason requires nightly garbage collection of old objects. To schedule this
job create a script in your /etc/cron.daily folder which specifies the
following:

#---reason_garbage_collection.sh-start------------------------------------------------------------------
#!/bin/sh

/path/to/bin/php /path/to/reason_package/reason_4.0/lib/core/scripts/db_maintenance/scripts/garbage_collector.php3 > /tmp/reason_garbage/web_garbage_dump.`date +\%Y\%m\%d`.txt

#---reason_garbage_collection.sh-end--------------------------------------------------------------------

Note that you must create the folder /tmp/reason_garbage .  Also, the
/path/to/ values must be filled in specific to your site.

******************************************************************************************

Final setup

Once everything is configured, run the reason_setup.php script in the reason_package directory.

The script will do some basic verification checks to see if reason is properly setup, and create an 
administrative user with username "admin" and a random password. Write down the password! The user
created by the script has a unique name and will only be created once. For extra security, delete or
move the script from the web tree after it has been run.

Signing In

	Once everything is configured you should be able to sign in to the Reason admin interface at the following URL:

	https://your.reason.webserver/reason/

	Enter the username "admin" and the randomly created password. Enjoy.

